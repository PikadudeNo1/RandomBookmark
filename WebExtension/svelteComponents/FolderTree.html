<ul ref:node on:keydown="keyboardInput(event)" role="tree"><FolderNodeList {list} {useAutoOpen}/></ul>
<script>
import FolderNodeList from './FolderNodeList.html';
var edgeKeys = {
    Spacebar: " ",
    Down: "ArrowDown",
    Left: "ArrowLeft",
    Right: "ArrowRight",
	Up: "ArrowUp",
};
export default {
	oncreate() {
		// TODO: Make sure selected can't be a node that has disappeared
		this.on("state", ({changed, current, previous}) => {
			if (!changed.selected) { return; }
			if (previous.selected) {
				previous.selected.component.set({selected: false});
			}
			current.selected.component.set({selected: true});
		});
		this.set({selected: this.refs.node.firstElementChild});
	},
	methods: {
		keyboardInput(event) {
			var curFocus = event.target.closest(".folderNode");
			var newFocus = null;
			var key = event.key;
			key = edgeKeys[key] || key;
			var ctrl = event.ctrlKey;
			if (key == "ArrowUp") {
				if (curFocus.matches(":first-child")) {
					newFocus = curFocus.parentElement.closest("li"); // may be null
				} else {
					newFocus = curFocus.previousElementSibling;
					if (newFocus.querySelector("ul")) {
						let allItems = newFocus.querySelectorAll("li");
						newFocus = allItems[allItems.length - 1];
					}
				}
			} else if (key == "ArrowDown") {
				let childList = curFocus.querySelector("ul");
				if (childList) {
					newFocus = childList.firstElementChild;
				} else {
					let moveFrom = curFocus.closest("li:not(:last-child)");
					if (moveFrom) {
						newFocus = moveFrom.nextElementSibling;
					}
				}
			} else if (key == "ArrowLeft") {
				if (curFocus.querySelector("ul")) {
					curFocus.component.set({showSubfolders: false});
				} else {
					newFocus = curFocus.parentElement.closest("li"); // may be null
				}
			} else if (key == "ArrowRight") {
				if (!curFocus.querySelector("ul")) {
					curFocus.component.expandIfExpandable();
				} else {
					newFocus = curFocus.querySelector("ul").firstElementChild;
				}
			} else if (key == "Enter") {
				if (ctrl && curFocus.querySelector(".andSubfolders")) {
					curFocus.querySelector(".andSubfolders").click();
				} else {
					curFocus.querySelector(".folderName").click();
				}
			} else if (ctrl && key == "p") {
				curFocus.querySelector(".pin").click();
				event.preventDefault();
			} else if (key == "Home") {
				newFocus = this.refs.node.firstElementChild;
			} else if (key == "End") {
				let allItems = this.refs.node.querySelectorAll("li");
				newFocus = allItems[allItems.length - 1];
			}
			if (newFocus) {
				event.preventDefault();
				this.set({selected: newFocus});
				newFocus.component.refs.focusMe.focus();
			}
		},
	},
	components: { FolderNodeList }
};
</script>